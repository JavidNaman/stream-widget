<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
    --glass-bg: rgba(8, 10, 14, 0.86);
    --glass-top: rgba(255, 255, 255, 0.07);
    --glass-stroke: rgba(255, 255, 255, 0.22);
    --text-main: #f7f9fc;
    --text-subtle: #d1d8e2;
    --accent: #f0f4fa;
}
body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: 'Vazirmatn', sans-serif;
    -webkit-font-smoothing: antialiased;
    text-rendering: geometricPrecision;
}
#widget-wrapper {
    display: inline-flex;
    position: relative;
    isolation: isolate;
    background: var(--glass-bg);
    backdrop-filter: blur(14px) saturate(125%);
    -webkit-backdrop-filter: blur(14px) saturate(125%);
    border: 1px solid var(--glass-stroke);
    box-shadow: none;
    border-radius: 22px;
    padding: 14px 18px;
    gap: 14px;
    align-items: center;
    opacity: 0;
    transition: opacity 0.9s ease-in-out;
    width: max-content;
    direction: rtl;
}
#widget-wrapper::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: linear-gradient(180deg, var(--glass-top), rgba(255, 255, 255, 0));
    pointer-events: none;
    z-index: 0;
}
.visible {
    opacity: 1 !important;
}
.avatar-box {
    width: 78px;
    height: 78px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    border: 1px solid rgba(255, 255, 255, 0.38);
    background: rgba(0, 0, 0, 0.2);
    box-shadow: none;
}
.avatar-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.info-box {
    display: flex;
    flex-direction: column;
    gap: 4px;
    text-align: right;
    min-width: 0;
    max-width: 420px;
    position: relative;
    z-index: 1;
}
.info-box p {
    text-shadow: none;
}
.name-label {
    font-size: 19px;
    font-weight: 700;
    color: var(--text-main);
    margin: 0;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    letter-spacing: 0.1px;
}
.detail-label {
    font-size: 16px;
    color: var(--text-subtle);
    margin: 0;
    font-weight: 400;
    line-height: 1.35;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#info-age {
    color: var(--accent);
    font-weight: 500;
}
.is-hidden {
    display: none;
}
</style>
</head>
<body>
<div id="widget-wrapper">
    <div class="avatar-box">
        <img id="avatar-img" src="" alt="">
    </div>
    <div class="info-box">
        <p id="info-name" class="name-label"></p>
        <p id="info-age" class="detail-label"></p>
        <p id="info-loc" class="detail-label"></p>
    </div>
</div>
<script>
let entries = [];
let activeIdx = 0;
let isCycling = false;
let cycleTimer = null;

const DISPLAY_MS = 5000;
const FADE_MS = 900;

const widgetWrapper = document.getElementById('widget-wrapper');
const avatarImg = document.getElementById('avatar-img');
const infoName = document.getElementById('info-name');
const infoAge = document.getElementById('info-age');
const infoLoc = document.getElementById('info-loc');

function preloadImage(url) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve();
        img.onerror = reject;
        img.src = url;
    });
}

async function resolveImageReady(url) {
    const safeUrl = url === null || url === undefined ? '' : String(url).trim();
    if (!safeUrl) return { ok: false, url: '' };
    try {
        await preloadImage(safeUrl);
        return { ok: true, url: safeUrl };
    } catch {
        return { ok: false, url: '' };
    }
}

function setOptionalText(el, value, prefix = '') {
    const text = value === null || value === undefined ? '' : String(value).trim();
    if (!text) {
        el.classList.add('is-hidden');
        el.innerText = '';
        return;
    }
    el.classList.remove('is-hidden');
    el.innerText = prefix + text;
}

async function applyData(idx, imageState = null) {
    const current = entries[idx];
    const resolved = imageState || await resolveImageReady(current.image_url);

    if (resolved.ok) {
        avatarImg.src = resolved.url;
        avatarImg.parentElement.classList.remove('is-hidden');
    } else {
        avatarImg.removeAttribute('src');
        avatarImg.parentElement.classList.add('is-hidden');
    }

    const fullName = [current.first_name, current.last_name].filter(Boolean).join(' ').trim();
    infoName.innerText = fullName || 'Unknown';
    avatarImg.alt = fullName;
    setOptionalText(infoAge, current.age, 'سن: ');
    setOptionalText(infoLoc, current.location, 'شهر: ');
    widgetWrapper.classList.add('visible');
}

function getNextIndex() {
    const nextIdx = (activeIdx + 1) % entries.length;
    if (nextIdx === 0) {
        entries.sort(() => Math.random() - 0.5);
    }
    return nextIdx;
}

function preloadNextImage() {
    if (entries.length < 2) return;
    const nextIdx = getNextIndex();
    const nextUrl = entries[nextIdx].image_url === null || entries[nextIdx].image_url === undefined
        ? ''
        : String(entries[nextIdx].image_url).trim();
    if (!nextUrl) return;
    preloadImage(nextUrl).catch(() => {});
}

function scheduleNextCycle() {
    if (cycleTimer) {
        clearTimeout(cycleTimer);
    }
    cycleTimer = setTimeout(cycleWidget, DISPLAY_MS);
}

async function cycleWidget() {
    if (isCycling || entries.length <= 1) return;
    isCycling = true;
    const nextIdx = getNextIndex();
    const nextImageState = await resolveImageReady(entries[nextIdx].image_url);

    widgetWrapper.classList.remove('visible');
    setTimeout(async () => {
        activeIdx = nextIdx;
        try {
            await applyData(activeIdx, nextImageState);
            preloadNextImage();
        } finally {
            isCycling = false;
            scheduleNextCycle();
        }
    }, FADE_MS);
}

async function fetchData() {
    try {
        const req = await fetch('https://raw.githubusercontent.com/JavidNaman/stream-widget/main/data.json');
        const rawData = await req.json();
        if (Array.isArray(rawData) && rawData.length > 0) {
            entries = rawData.sort(() => Math.random() - 0.5);
            await applyData(activeIdx);
            preloadNextImage();
            scheduleNextCycle();
        }
    } catch {}
}

fetchData();
</script>
</body>
</html>
