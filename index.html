<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
    --glass-bg: rgba(12, 12, 14, 0.52);
    --glass-top: rgba(255, 255, 255, 0.10);
    --glass-stroke: rgba(255, 255, 255, 0.22);
    --text-main: #f4f6f8;
    --text-subtle: #c8cdd3;
    --accent: #e1e5ea;
}
body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: 'Vazirmatn', sans-serif;
}
#widget-wrapper {
    display: inline-flex;
    position: relative;
    isolation: isolate;
    background: var(--glass-bg);
    backdrop-filter: blur(18px) saturate(115%);
    -webkit-backdrop-filter: blur(18px) saturate(115%);
    border: 1px solid var(--glass-stroke);
    box-shadow:
        0 14px 40px rgba(0, 0, 0, 0.5),
        0 1px 0 rgba(255, 255, 255, 0.12) inset;
    border-radius: 22px;
    padding: 14px 16px;
    gap: 12px;
    align-items: center;
    opacity: 0;
    transition: opacity 0.9s ease-in-out;
    width: max-content;
    direction: rtl;
}
#widget-wrapper::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: linear-gradient(180deg, var(--glass-top), rgba(255, 255, 255, 0));
    pointer-events: none;
    z-index: 0;
}
.visible {
    opacity: 1 !important;
}
.avatar-box {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    border: 1px solid rgba(255, 255, 255, 0.38);
    background: rgba(0, 0, 0, 0.2);
    box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.12),
        0 8px 20px rgba(0, 0, 0, 0.35);
}
.avatar-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.info-box {
    display: flex;
    flex-direction: column;
    gap: 4px;
    text-align: right;
    min-width: 170px;
    position: relative;
    z-index: 1;
}
.info-box p {
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.45);
}
.name-label {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-main);
    margin: 0;
    line-height: 1.15;
}
.detail-label {
    font-size: 14px;
    color: var(--text-subtle);
    margin: 0;
    font-weight: 400;
    line-height: 1.25;
}
#info-age {
    color: var(--accent);
    font-weight: 500;
}
.is-hidden {
    display: none;
}
@media (max-width: 520px) {
    #widget-wrapper {
        padding: 11px 13px;
        gap: 10px;
        border-radius: 16px;
    }
    .avatar-box {
        width: 60px;
        height: 60px;
    }
    .name-label {
        font-size: 18px;
    }
    .detail-label {
        font-size: 13px;
    }
    .info-box {
        min-width: 140px;
    }
}
</style>
</head>
<body>
<div id="widget-wrapper">
    <div class="avatar-box">
        <img id="avatar-img" src="" alt="">
    </div>
    <div class="info-box">
        <p id="info-name" class="name-label"></p>
        <p id="info-age" class="detail-label"></p>
        <p id="info-loc" class="detail-label"></p>
    </div>
</div>
<script>
let entries = [];
let activeIdx = 0;
let isCycling = false;
let cycleTimer = null;

const DISPLAY_MS = 5000;
const FADE_MS = 900;

const widgetWrapper = document.getElementById('widget-wrapper');
const avatarImg = document.getElementById('avatar-img');
const infoName = document.getElementById('info-name');
const infoAge = document.getElementById('info-age');
const infoLoc = document.getElementById('info-loc');

async function fetchData() {
    try {
        const req = await fetch('https://raw.githubusercontent.com/JavidNaman/stream-widget/main/data.json');
        const rawData = await req.json();
        if (rawData.length > 0) {
            entries = rawData.sort(() => Math.random() - 0.5);
            await applyData(activeIdx);
            preloadNextImage();
            scheduleNextCycle();
        }
    } catch {}
}

function preloadImage(url) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve();
        img.onerror = reject;
        img.src = url;
    });
}

async function applyData(idx) {
    const current = entries[idx];
    await preloadImage(current.image_url);
    avatarImg.src = current.image_url;
    const fullName = [current.first_name, current.last_name].filter(Boolean).join(' ').trim();
    infoName.innerText = fullName || 'Unknown';
    setOptionalText(infoAge, current.age, 'سن: ');
    setOptionalText(infoLoc, current.location, 'شهر: ');
    widgetWrapper.classList.add('visible');
}

function setOptionalText(el, value, prefix = '') {
    const text = value === null || value === undefined ? '' : String(value).trim();
    if (!text) {
        el.classList.add('is-hidden');
        el.innerText = '';
        return;
    }
    el.classList.remove('is-hidden');
    el.innerText = prefix + text;
}

function getNextIndex() {
    const nextIdx = (activeIdx + 1) % entries.length;
    if (nextIdx === 0) {
        entries.sort(() => Math.random() - 0.5);
    }
    return nextIdx;
}

function preloadNextImage() {
    if (entries.length < 2) return;
    const nextIdx = getNextIndex();
    preloadImage(entries[nextIdx].image_url).catch(() => {});
}

function scheduleNextCycle() {
    if (cycleTimer) {
        clearTimeout(cycleTimer);
    }
    cycleTimer = setTimeout(cycleWidget, DISPLAY_MS);
}

async function cycleWidget() {
    if (isCycling || entries.length <= 1) return;
    isCycling = true;
    const nextIdx = getNextIndex();

    try {
        await preloadImage(entries[nextIdx].image_url);
    } catch {
        isCycling = false;
        cycleTimer = setTimeout(cycleWidget, 1500);
        return;
    }

    widgetWrapper.classList.remove('visible');
    setTimeout(async () => {
        activeIdx = nextIdx;
        try {
            await applyData(activeIdx);
            preloadNextImage();
        } finally {
            isCycling = false;
            scheduleNextCycle();
        }
    }, FADE_MS);
}

fetchData();
</script>
</body>
</html>
